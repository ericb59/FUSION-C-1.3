/*
 ___________________________________________________________
/               __           _                              \
|              / _|         (_)                             |
|             | |_ _   _ ___ _  ___  _ __                   |
|             |  _| | | / __| |/ _ \| '_ \                  |
|             | | | |_| \__ \ | (_) | | | |                 |
|             |_|  \__,_|___/_|\___/|_| |_| *               |
|                                                           |
|               The MSX C Library for SDCC                  |
|                 E X A M P L E  C O D E                    |
|                                            FUSION-C v1.3  |
\___________________________________________________________/
*/
// Example : Load and Play PT3 Music File + Play AYFX Samples
//            Use VDP Interruption to Stream Music and Sound to the PSG
// Works on MSX and upper  
//
// Need External files :
//    Music1.pt3
// 

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "fusion-c/header/msx_fusion.h"
#include "fusion-c/header/pt3replayer.h"


#define SONG_BUFFER 9000

static FCB file; 
signed char Pt3_flag;
const  char chase[] = 
{0x08, 0x0F, 0x00, 0x62, 0x00, 0x92, 0x00, 0xF8, 0x00, 0x4D, 0x01, 0xA8, 0x01, 0xC6, 0x01, 0x1E, 
   0x02, 0x6A, 0x50, 0x05, 0x1E, 0x0A, 0x2B, 0x50, 0x06, 0x0B, 0x2C, 0x50, 0x07, 0x0C, 0x6E, 0x50, 
   0x08, 0x0A, 0x0E, 0x0E, 0x0E, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6C, 0x50, 0x07, 0x1E, 0x0C, 
   0x2D, 0x50, 0x08, 0x0D, 0x2E, 0x50, 0x09, 0x0E, 0x6F, 0x52, 0x0A, 0x0A, 0x0F, 0x0F, 0x0F, 0x20, 
   0x00, 0x00, 0x00, 0x00, 0x00, 0x6C, 0x50, 0x09, 0x1E, 0x0C, 0x2D, 0x00, 0x0A, 0x0D, 0x2E, 0x50, 
   0x0A, 0x0E, 0x6F, 0x52, 0x0B, 0x0A, 0x0F, 0x0F, 0x0F, 0xD0, 0x20, 0x6E, 0x65, 0x6D, 0x65, 0x73, 
   0x69, 0x73, 0x5F, 0x31, 0x31, 0x00, 0xEF, 0x80, 0x00, 0x0A, 0xAF, 0x00, 0x01, 0xAE, 0x80, 0x01, 
   0xAE, 0x00, 0x02, 0xAD, 0x80, 0x02, 0xAD, 0x00, 0x03, 0xAE, 0x80, 0x01, 0xAE, 0x40, 0x01, 0xAD, 
   0x00, 0x01, 0xA8, 0xC0, 0x00, 0xA8, 0x80, 0x00, 0xA8, 0x60, 0x00, 0xD0, 0x20, 0x6E, 0x65, 0x6D, 
   0x65, 0x73, 0x69, 0x73, 0x5F, 0x31, 0x32, 0x00, 0x6D, 0x00, 0x01, 0x0A, 0x2E, 0x00, 0x03, 0x2D, 
   0x00, 0x01, 0x2E, 0x00, 0x03, 0x2C, 0x80, 0x00, 0xB0, 0x08, 0x09, 0xAC, 0xA0, 0x02, 0xAC, 0x60, 
   0x01, 0xB0, 0x08, 0x09, 0x29, 0xF0, 0x03, 0x09, 0x09, 0x29, 0x80, 0x03, 0x09, 0x09, 0x2A, 0x20, 
   0x03, 0x0A, 0x0A, 0x2A, 0xB0, 0x02, 0x0A, 0x0A, 0x2B, 0xA0, 0x02, 0x0B, 0x0B, 0x2B, 0x70, 0x02, 
   0x0B, 0x0B, 0x2B, 0xA0, 0x02, 0x0B, 0x0B, 0x2A, 0x00, 0x03, 0x0A, 0x0A, 0x29, 0x00, 0x04, 0x09, 
   0x09, 0x28, 0x00, 0x05, 0x08, 0x08, 0x27, 0x00, 0x06, 0x07, 0x07, 0x26, 0x00, 0x07, 0x06, 0x06, 
   0xA8, 0x01, 0x00, 0xD0, 0x20, 0x66, 0x69, 0x72, 0x65, 0x62, 0x69, 0x72, 0x64, 0x5F, 0x36, 0x00, 
   0xEB, 0x70, 0x02, 0x0A, 0x6F, 0xA0, 0x00, 0x1E, 0xB0, 0x09, 0x09, 0x90, 0x90, 0xAB, 0xA0, 0x02, 
   0xAD, 0xC0, 0x01, 0xAC, 0x1A, 0x02, 0xAD, 0x40, 0x02, 0xAC, 0x6A, 0x02, 0xAB, 0xD0, 0x02, 0xAA, 
   0x00, 0x05, 0xA9, 0x60, 0x06, 0xA8, 0x00, 0x02, 0xA8, 0x00, 0x03, 0xB0, 0x09, 0x09, 0x90, 0xA9, 
   0x1A, 0x02, 0xAA, 0x40, 0x02, 0xAA, 0x6A, 0x02, 0xA9, 0xD0, 0x02, 0xA9, 0x00, 0x05, 0xA8, 0x60, 
   0x06, 0xA7, 0x00, 0x02, 0xA6, 0x00, 0x03, 0xA8, 0x01, 0x00, 0xD0, 0x20, 0x66, 0x69, 0x72, 0x65, 
   0x62, 0x69, 0x72, 0x64, 0x5F, 0x37, 0x00, 0x68, 0x18, 0x00, 0x00, 0x27, 0x10, 0x00, 0x29, 0x24, 
   0x00, 0x28, 0x10, 0x00, 0x2A, 0x24, 0x00, 0x29, 0x10, 0x00, 0x2B, 0x24, 0x00, 0x29, 0x10, 0x00, 
   0x2A, 0x24, 0x00, 0x29, 0x10, 0x00, 0x2A, 0x24, 0x00, 0x28, 0x10, 0x00, 0x29, 0x24, 0x00, 0x27, 
   0x10, 0x00, 0x28, 0x24, 0x00, 0x26, 0x10, 0x00, 0x27, 0x24, 0x00, 0x25, 0x10, 0x00, 0x26, 0x24, 
   0x00, 0x24, 0x10, 0x00, 0x25, 0x24, 0x00, 0x23, 0x10, 0x00, 0x24, 0x24, 0x00, 0x23, 0x10, 0x00, 
   0x23, 0x24, 0x00, 0xA8, 0x01, 0x00, 0xD0, 0x20, 0x66, 0x69, 0x72, 0x65, 0x62, 0x69, 0x72, 0x64, 
   0x5F, 0x31, 0x33, 0x00, 0xEB, 0x28, 0x00, 0x1E, 0x89, 0x88, 0x89, 0xA6, 0x29, 0x00, 0xA5, 0x28, 
   0x00, 0x84, 0x83, 0xA8, 0x01, 0x00, 0xD0, 0x20, 0x66, 0x69, 0x72, 0x65, 0x62, 0x69, 0x72, 0x64, 
   0x5F, 0x31, 0x32, 0x00, 0xED, 0xF0, 0x02, 0x02, 0xAD, 0xB0, 0x02, 0xAD, 0xF0, 0x02, 0xAD, 0xB0, 
   0x02, 0xAD, 0x80, 0x02, 0xAD, 0x50, 0x02, 0xAD, 0x38, 0x02, 0xAD, 0x20, 0x02, 0xAD, 0x08, 0x02, 
   0xAD, 0xF0, 0x01, 0xAD, 0xD8, 0x01, 0xAD, 0xC0, 0x01, 0xAC, 0x20, 0x02, 0xAC, 0x08, 0x02, 0xAC, 
   0xF0, 0x01, 0xAC, 0xD8, 0x01, 0xAC, 0xC0, 0x01, 0xAC, 0xA8, 0x01, 0xAC, 0x90, 0x01, 0xAB, 0xF0, 
   0x01, 0xAB, 0xD8, 0x01, 0xAB, 0xC0, 0x01, 0xAB, 0xA8, 0x01, 0xAB, 0x90, 0x01, 0xA5, 0x00, 0x00, 
   0xD0, 0x20, 0x6D, 0x65, 0x74, 0x61, 0x6C, 0x67, 0x65, 0x61, 0x72, 0x5F, 0x38, 0x00, 0xEE, 0x60, 
   0x00, 0x1E, 0xAE, 0x80, 0x00, 0xAE, 0x60, 0x00, 0xAE, 0x80, 0x00, 0xAE, 0xC0, 0x00, 0xAE, 0x00, 
   0x01, 0xAE, 0x40, 0x01, 0xAE, 0x80, 0x01, 0xAE, 0x40, 0x01, 0xAE, 0x00, 0x01, 0xAE, 0xC0, 0x00, 
   0xAE, 0x80, 0x00, 0xAE, 0x60, 0x00, 0xAC, 0x80, 0x00, 0xAC, 0xC0, 0x00, 0xAC, 0x00, 0x01, 0xAC, 
   0x40, 0x01, 0xAC, 0x80, 0x01, 0xAC, 0x40, 0x01, 0xAC, 0x00, 0x01, 0xAC, 0xC0, 0x00, 0xAC, 0x80, 
   0x00, 0xAC, 0x60, 0x00, 0xD0, 0x20, 0x6E, 0x65, 0x6D, 0x65, 0x73, 0x69, 0x73, 0x5F, 0x38, 0x00};



unsigned char song[SONG_BUFFER];  

/* ---------------------------------
            FT_errorHandler

          In case of Error
-----------------------------------*/ 
void FT_errorHandler(char n, char *name)
{
 Screen(0);

  SetColors(15,6,6);
  switch (n)
  {
      case 1:
          printf("\n\rFAILED: fcb_open(): %s ",name);
      break;

      case 2:
          printf("\n\rFAILED: fcb_close(): %s",name);
      break;  

      case 3:
          printf("\n\rSORRY: this game does not work on %s",name);
      break; 
  }

Exit(0);
}

/* ---------------------------------
                FT_SetName

    Set the name of a file to load
                (MSX DOS)
-----------------------------------*/ 
void FT_SetName( FCB *p_fcb, const char *p_name ) {
  char i, j;
  memset( p_fcb, 0, sizeof(FCB) );
  for( i = 0; i < 11; i++ ) {
    p_fcb->name[i] = ' ';
  }
  for( i = 0; (i < 8) && (p_name[i] != 0) && (p_name[i] != '.'); i++ ) {
    p_fcb->name[i] =  p_name[i];
  }
  if( p_name[i] == '.' ) {
    i++;
    for( j = 0; (j < 3) && (p_name[i + j] != 0) && (p_name[i + j] != '.'); j++ ) {
      p_fcb->ext[j] =  p_name[i + j] ;
    }
  }
}


/* ---------------------------------
          FT_LoadData
  Load Data to a specific pointer
  size is the size of data to read
  skip represent the number of Bytes
  you want to skip from the begining of the file
  Example: skip=7 to skip 7 bytes of a MSX bin
-----------------------------------*/ 
int FT_LoadData(char *file_name, char *buffer, int size, int skip)
{
    
    FT_SetName( &file, file_name );
    if(fcb_open( &file ) != FCB_SUCCESS) 
    {
          FT_errorHandler(1, file_name);
          return (0);
    }
    if (skip>0)
    {
        fcb_read( &file, buffer, skip );
    }
   
    
    fcb_read( &file, buffer, size );
    
    if( fcb_close( &file ) != FCB_SUCCESS ) 
    {
      FT_errorHandler(2, file_name);
      return (0);
    }
    return(0);
}
void routing(void)
{
         
          PT3Rout();          // Route the PT3 music to PSGPT3Rout
          if(Pt3_flag==1)
          {
            PT3Play();      // Play/Update the music playing
          }

         PT3FXRout();          // Route the AYFX sounds to PSG
   
}
void main (void)
{

  int n,k;
  n=1;
  Pt3_flag=1;
  Cls();
  Print("\n\rAYFX Initialisation...");
  InitPSG();
  PT3FXInit(chase,2);          // Itialising AYFX BANK named "Chase" to use PSG Channel 2

  Print("\n\rLoading music...");
  FT_LoadData("music1.pt3", song, 8417, 0);

  Print("\n\rPT3 Initialisation...");
  PT3Init (song, 1);

  Print("\n\r : Playing Music...");

  Print("\n\r\n\r Press Keys A,B,C,D,E,F,G,H to play FX Sounds ");
  Print("\n\r\n\r Press Keys M to Mute/playmusic ");
  Print("\n\r\n\r Press ESC to quit");




  InitVDPInterruptHandler((int)routing);      /// VDP Interruption

  KeySound(0);
    while (n==1)
    {
     k=Inkey();
      switch (k)
      {
          case 97:

            PT3FXPlay(0,10);
          break;

          case 98:
   
              PT3FXPlay(1,5);
          break;  

          case 99:
   
             PT3FXPlay(2,0);
           break;

           case 100:

            PT3FXPlay(3,10);
           break;

           case 101:

             PT3FXPlay(4,0);
           break;

           case 102:
             PT3FXPlay(5,8);
           break;

           case 103:
             PT3FXPlay(6,15);
           break;


           case 104:
             PT3FXPlay(7,10);
           break;


           case 105:
             PT3FXPlay(8,10);
           break;


           case 106:
             PT3FXPlay(9,10);
           break;


           case 107:
             PT3FXPlay(10,10);
           break;

            case 109:
             
                Pt3_flag=Pt3_flag*-1;
                 PT3Mute();
           break;

            case 110:
             
                ayFX_CHANNEL++;
                if (ayFX_CHANNEL>5)
                  ayFX_CHANNEL=0;
           break;

           case 27:
                n=0;
                EndVDPInterruptHandler();
                PT3Mute();
                Exit(0);
           break;

      }
         
          Locate (0,12);
          Print("\n\rPlay Sound FX:");
          PrintDec(ayFX_MODE);
          Locate (0,13);
          Print("\n\rChannel:");
          PrintDec(ayFX_CHANNEL);
          Locate (0,14);
          Print("\n\rPriority:");
          PrintDec(ayFX_PRIORITY);
          Print("     ");
          

      
    }

   
   
  

}